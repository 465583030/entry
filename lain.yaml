appname: entry

build:
    base: golang:1.10
    prepare:
        version: 20180309
        script:
            # - sed -i 's|deb.debian.org|mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list
            # - sed -i 's|security.debian.org|mirrors.tuna.tsinghua.edu.cn/debian-security|g' /etc/apt/sources.list
            - curl -sL https://deb.nodesource.com/setup_9.x | bash -
            - apt-get -y update && apt-get -y install apt-transport-https ca-certificates golang-glide nodejs
            - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
            - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
            - apt-get -y update && apt-get -y install yarn
            - mkdir -p $GOPATH/src/github.com/laincloud/entry
            - cp -rf . $GOPATH/src/github.com/laincloud/entry
            - cd $GOPATH/src/github.com/laincloud/entry && glide install
            - go install github.com/laincloud/entry/server/gen/cmd/entry-server
            - cd $GOPATH/src/github.com/laincloud/entry/frontend/ && yarn install
    script:
        - cp -rf . $GOPATH/src/github.com/laincloud/entry
        - go install github.com/laincloud/entry/server/gen/cmd/entry-server
        - cd $GOPATH/src/github.com/laincloud/entry/frontend/ && yarn build

test:
    script:
        - go test github.com/laincloud/entry/server/...

release:
    dest_base: laincloud/nginx:1.13
    copy:
        - src: $GOPATH/bin/entry-server
          dest: /lain/app/entry-server
        - src: nginx.conf
          dest: /etc/nginx/conf.d/default.conf
        - src: $GOPATH/src/github.com/laincloud/entry/frontend/build
          dest: /usr/share/nginx/html

web:  # backend
    cmd: /lain/app/entry-server --config=/lain/app/prod.json --host=0.0.0.0 --port=80
    port: 80
    healthcheck: /api/ping
    memory: 256M
    env:
        - LAINLET_PORT=9001
        - SWARM_PORT=2376
    secret_files:
        - /lain/app/prod.json
    cloud_volumes:
        type: single
        dirs:
            - /cloud

proc.frontend:
    type: web
    cmd: nginx -g "daemon off;"
    port: 80
    healthcheck: /ping
    mountpoint:
        - /web
    https_only: true
    memory: 32M
